{% extends 'main.html' %}
{% load hashtags %}



{% block content %}

<style>
  .hashtag {
    color: #7494eb; /* dark blue */
    font-weight: bold;
    cursor: pointer;
}
.hashtag:hover {
    text-decoration: underline;
}

.hashtag-form input {
  padding: 5px;
  border-radius: 5px;
  border: 1px solid #ccc;
}
.hashtag-form button {
  background-color: #1d4ed8;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
}

/* <--new sidebar--> */
.room__sidebar {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Common styles for both boxes */
.participants,
.hashtags {
  width: 100%; /* equal width */
  background: rgba(255, 255, 255, 0.15); /* translucent white layer */
  backdrop-filter: blur(6px); /* smooth glass effect */
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 12px;
  padding: 12px;
  color: #fff; /* adjust text color if your page bg is dark */
}

/* Headings (Participants, Hashtags) */
.participants__top {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #f8fafc;
}

/* Scrollable lists */
.participants__list {
  max-height: 200px;
  overflow-y: auto;
}

/* Hashtag items (small, neat tag style) */
.hashtags .hashtag {
  display: inline-block;
  background: rgba(255, 255, 255, 0.1);
  color: #dbeafe;
  padding: 4px 8px;
  border-radius: 6px;
  margin: 3px;
  font-size: 13px;
  text-decoration: none;
}

.hashtags .hashtag:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* Avatar and participant alignment (optional) */
.participant {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #f1f5f9;
  text-decoration: none;
  padding: 4px 0;
}

.hashtag.selected {
    background-color: rgba(29, 78, 216, 0.2); /* translucent blue */
    padding-right: 20px;
    position: relative;
}

.clear-hashtag {
    position: absolute;
    right: 5px;
    top: 2px;
    font-weight: bold;
    color: #333;
    cursor: pointer;
}

.clear-hashtag a {
    color: #333;
    text-decoration: none;
}


.thread__flashcard,
.thread__hashtagBtn {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* clean, modern font */
  color: #f9fafe;        /* dark blue link color */
  text-decoration: none;  /* remove underline */
  font-weight: 400;
  font-size: 1.5rem;
  cursor: pointer;
  transition: color 0.2s;
  margin-top: 8px;  /* adds space above */
  display: inline-block; /* ensures margin-top works */
}

.thread__flashcard:hover,
.thread__hashtagBtn:hover {
  color: #6262ec; /* slightly lighter blue on hover */
  text-decoration:none; /* subtle hover effect */
}

.thread__hashtagWrapper {
  position: relative;
  display: inline-block;
  margin-left: 10px; /* spacing from other link */
}
/* ----- */



.thread__hashtagForm {
  position: absolute;
  top: 30px;
  left: 0;
  background: rgba(255, 255, 255, 0.95);
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
  z-index: 100;
  display: flex;
  gap: 4px;
  width: 260px;
  /* height: ; */
}

.thread__hashtagForm input {
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
  font-size: 0.9rem;
  width: 200px;
  height: 30px;
}

.thread__hashtagForm button {
  background-color: #1d4ed8;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 0.9rem;
  width: auto;
  height: 30px;
}

.thread__hashtagForm button:hover {
  background-color: #2563eb;
}

input[name="hashtag"]::placeholder {
    font-size: 1.1rem;   /* increase text size */
    color: #999;         /* optional: change color */
    font-weight: 500;    /* optional: make it slightly bold */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* optional: change font */
}


/* pdfs and images */
.thread__image {
  max-width: 250px;
  border-radius: 10px;
  margin-top: 8px;
}

.thread__pdfLink {
  display: inline-block;
  margin-top: 5px;
  color: var(--color-main);
  text-decoration: underline;
  font-weight: 500;
}

.thread__image {
    display: block;            /* keeps it block-level like <p> */
    margin-block-start: 1em;   /* top margin */
    margin-block-end: 1em;     /* bottom margin */
    margin-inline-start: 0;    
    margin-inline-end: 0;
    unicode-bidi: isolate;

    width: 100%;               /* make image expand to container width */
    max-width: 700px;            /*optional: limits the max width */
    height: auto;              /* keeps aspect ratio */
    border-radius: 8px;        /* optional: rounded corners */
    border: 1px solid #ccc;    /* optional: border like a text box */
}



.thread__pdfLink{
    display: block;
    margin-block-start: 1em;
    margin-block-end: 1em;
    margin-inline-start: 0px;
    margin-inline-end: 0px;
    unicode-bidi: isolate;
}


</style>
<main class="profile-page layout layout--2">
  <div class="container">
    <!-- Room Start -->
    <div class="room">
      <div class="room__top">
        <div class="room__topLeft">
          <a href="{% url 'home' %}">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <title>arrow-left</title>
              <path
                d="M13.723 2.286l-13.723 13.714 13.719 13.714 1.616-1.611-10.96-10.96h27.625v-2.286h-27.625l10.965-10.965-1.616-1.607z">
              </path>
            </svg>
          </a>
          <h3>Study Room</h3>
        </div>
        {% if room.host == request.user %}
        <div class="room__topRight">
          <a href="{% url 'update-room' room.id %}">
            <svg enable-background="new 0 0 24 24" height="32" viewBox="0 0 24 24" width="32"
              xmlns="http://www.w3.org/2000/svg">
              <title>edit</title>
              <g>
                <path d="m23.5 22h-15c-.276 0-.5-.224-.5-.5s.224-.5.5-.5h15c.276 0 .5.224.5.5s-.224.5-.5.5z" />
              </g>
              <g>
                <g>
                  <path
                    d="m2.5 22c-.131 0-.259-.052-.354-.146-.123-.123-.173-.3-.133-.468l1.09-4.625c.021-.09.067-.173.133-.239l14.143-14.143c.565-.566 1.554-.566 2.121 0l2.121 2.121c.283.283.439.66.439 1.061s-.156.778-.439 1.061l-14.142 14.141c-.065.066-.148.112-.239.133l-4.625 1.09c-.038.01-.077.014-.115.014zm1.544-4.873-.872 3.7 3.7-.872 14.042-14.041c.095-.095.146-.22.146-.354 0-.133-.052-.259-.146-.354l-2.121-2.121c-.19-.189-.518-.189-.707 0zm3.081 3.283h.01z" />
                </g>
                <g>
                  <path
                    d="m17.889 10.146c-.128 0-.256-.049-.354-.146l-3.535-3.536c-.195-.195-.195-.512 0-.707s.512-.195.707 0l3.536 3.536c.195.195.195.512 0 .707-.098.098-.226.146-.354.146z" />
                </g>
              </g>
            </svg>
          </a>
          <a href="{% url 'delete-room' room.id %}">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <title>remove</title>
              <path
                d="M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z">
              </path>
            </svg>
          </a>
        </div>
        {% endif %}

      </div>
      <div class="room__box scroll">
        <div class="room__header scroll">
          <div class="room__info">
            <h3>{{room.name}}</h3>
            <span>{{room.created|timesince}} ago</span>
          </div>
          <div class="room__hosted">
            <p>Hosted By</p>
            <a href="{% url 'user-profile' room.host.id %}" class="room__author">
              <div class="avatar avatar--small">
                <img src="{{room.host.avatar.url}}" />
              </div>
              <span>@{{room.host.username}}</span>
            </a>
          </div>
          <!-- <div class="room__details">
            Lorem ipsum dolor sit, amet consectetur adipisicing elit. Quasi, tenetur laudantium? Dicta repellendus
            rerum consectetur, voluptatem repudiandae eum ea porro cupiditate provident nulla, deserunt, ab ipsum
            corporis laboriosam deleniti molestias?
          </div> -->
          <span class="room__topics">{{room.topic}}</span>
        </div>

        <div class="room__conversation">
          <div class="threads scroll">


            {% for message in room_messages %}
            <div class="thread">
              <div class="thread__top">
                <div class="thread__author">
                  <a href="{% url 'user-profile' message.user.id %}" class="thread__authorInfo">
                    <div class="avatar avatar--small">
                      <img src="{{message.user.avatar.url}}" />
                    </div>
                    <span>@{{message.user.username}}</span>
                  </a>
                  <span class="thread__date">{{message.created|timesince}} ago</span>
                  

                </div>

                {% if request.user == message.user %}
                <a href="{% url 'delete-message' message.id %}">
                  <div class="thread__delete">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                      <title>remove</title>
                      <path
                        d="M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z">
                      </path>
                    </svg>
                  </div>
                </a>
                
                {% endif %}
              </div>
              <a href="{% url 'generate-flashcard' message.id %}" class="thread__flashcard" title="Generate Flashcards">Flashcard</a>
              <!-- <a href="#" class="thread__hashtagBtn" onclick="openHashtagForm('{{ message.id }}')">Hashtag</a> -->
               <div class="thread__hashtagWrapper">
                <a href="javascript:void(0)" class="thread__hashtagBtn" onclick="openHashtagForm('{{ message.id }}')">Tags</a>
  
                <!-- hidden form -->
                <div class="thread__hashtagForm" id="hashtag-form-{{ message.id }}" style="display:none;">
                  <form method="POST" action="{% url 'add-hashtag' message.id %}">
                    {% csrf_token %}
                    <input type="text" name="hashtag" placeholder=" space-separated Tags" />
                    <button type="submit">Add</button>
                  </form>
                </div>
              </div>



              <!-- <form id="hashtagForm{{ message.id }}" class="hashtag-form" 
                    action="{% url 'add-hashtag' message.id %}" method="POST" style="display:none;">
                  {% csrf_token %}
                  <input type="text" name="hashtag" placeholder="#topicname" required />
                  <button type="submit">Add</button>
              </form> -->

              <!-- <div class="thread__details">
                {{message.body}} 
              </div> -->

<!-- this is now -->
              <!-- <div class="thread__details">
              {% for tag in message.hashtag_list %}
                <a href="?hashtag={{ tag }}" class="hashtag">{{ tag }}</a>
                <a href="{% url 'edit_message_hashtags' message.id %}">✏️ Edit</a>
              {% endfor %}
              
              {% if message.image %}
                <img src="{{ message.image.url }}" alt="Image" class="thread__image" />
              {% endif %}

              {% if message.pdf %}
                <a href="{{ message.pdf.url }}" target="_blank" class="thread__pdfLink">📄 View PDF</a>
              {% endif %}

              <p>{{ message.body|safe }}</p>
              

             
              </div> -->
              <div class="thread__details">
                {% for tag in message.hashtag_list %}
                  <a href="?hashtag={{ tag }}" class="hashtag">{{ tag }}</a>
                  <a href="{% url 'edit_message_hashtags' message.id %}">✏️ Edit</a>
                {% endfor %}
                
                {% if message.image %}
                  <img src="{{ message.image.url }}" alt="Image" class="thread__image" />
                {% endif %}

               {% if message.pdf %}
              <div class="thread__pdfPreview" style="display:flex; align-items:center; gap:8px; background:#9acdc9; padding:6px 10px; border-radius:6px; border:1px solid #ccc; margin:8px 0;">
                <span style="font-size:24px;">📄</span>
                <!-- <a href="{{ message.pdf.url }}" target="_blank" class="thread__pdfLink" style="font-size:16px;">📝</a> -->
                <span style="flex:1; font-size:14px; word-break:break-all; color:#000;">
                  <a href="{{ message.pdf.url }}" target="_blank" class="thread__pdfLink" style=" text-decoration: none; font-size:16px; color:#000;" >{{ message.pdf.name|slice:"10:" }}</a>
                </span>
                
                <a href="{{ message.pdf.url }}" download 
                  style="padding:4px 8px; background:#264653; color:#fff; border-radius:4px; text-decoration:none; font-size:12px;">
                  Download
                </a>
              </div>
            {% endif %}


                <p>{{ message.body|safe }}</p>
              </div>





              <!-- <div class="thread__details">
                {{ message.body|highlight_hashtags|urlize|linebreaks|safe }}
              </div> -->

              <!-- <div class="thread__details">
                {{ message.body|urlize|linebreaks }}
              </div> -->

            </div>
            {% endfor %}
          </div>
        </div>

      </div>
      <!-- <div class="room__message">
        <form action="" method="POST">
          {% csrf_token %}                                                       #working
          <input name="body" placeholder="Write your message here..." />
        </form>
      </div> -->
      <!-- <div class="room__message">
        <form action="" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="text" name="body" placeholder="Write your message here..." />

          <div class="upload__area">
            <label for="image-upload" title="Upload Image">📷</label>
            <input type="file" id="image-upload" name="image" accept="image/*" style="display:none;" />

            <label for="pdf-upload" title="Upload PDF">📄</label>
            <input type="file" id="pdf-upload" name="pdf" accept="application/pdf" style="display:none;" />
          </div>

          <button type="submit">Send</button>
        </form>
      </div> -->

<!-- this is old but correct -->
      <!-- <div class="room__message">
        <form action="" method="POST" enctype="multipart/form-data" style="width:100%;">
          {% csrf_token %}
          <div class="message-input-wrapper" style="display:flex; align-items:center; gap:8px; width:100%;"> -->
            
            <!-- Text input -->
            <!-- <input type="text" name="body" placeholder="Write your message here..." 
                  style="flex:1; padding:10px 12px; border-radius:6px; border:1px solid #ccc; outline:none;" /> -->

            <!-- Pin dropdown -->
            <!-- <div class="pin-dropdown" style="position:relative;">
              <button type="button" class="pin-btn" 
                      style="padding:8px 10px; border:none; background:#eee; border-radius:6px; cursor:pointer;">📌</button> -->
              
              <!-- Dropdown menu -->
              <!-- <div class="pin-menu" style="display:none; position:absolute; right:0; bottom:36px; background:#264653; 
                                          border:1px solid #ccc; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:10;">
                <label style="display:block; padding:8px 12px; cursor:pointer;">Photos
                  <input type="file" name="image" accept="image/*" style="display:none;">
                </label>
                <label style="display:block; padding:8px 12px; cursor:pointer;">Documents
                  <input type="file" name="pdf" accept="application/pdf" style="display:none;">
                </label>
              </div>
            </div> -->

            <!-- Send button -->
            <!-- <button type="submit" 
                    style="padding:8px 12px; border:none; background:#4fd1c5; color:white; border-radius:6px; cursor:pointer;">
              Send
            </button>
          </div>
        </form>
      </div> -->

      <div class="room__message">
        <form action="" method="POST" enctype="multipart/form-data" style="width:100%;">
          {% csrf_token %}
          <div class="message-input-wrapper" style="display:flex; align-items:center; gap:8px; width:100%;">
            
            <!-- Text input -->
            <input type="text" name="body" placeholder="Write your message here..." 
                  style="flex:1; padding:10px 12px; border-radius:6px; border:1px solid #ccc; outline:none;" />

            <!-- Pin dropup -->
            <div class="pin-dropup" style="position:relative;">
              <button type="button" class="pin-btn" 
                      style="padding:8px 10px; border:none; background:#eee; border-radius:6px; cursor:pointer;">📌</button>
              
              <!-- Dropup menu -->
              <div class="pin-menu" style="display:none; position:absolute; bottom:36px; right:0; background:#264653; 
                                          border:1px solid #ccc; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:10;">
                <label style="display:block; padding:8px 12px; cursor:pointer;">Photos
                  <input type="file" id="image-upload" name="image" accept="image/*" style="display:none;">
                </label>
                <label style="display:block; padding:8px 12px; cursor:pointer;">Documents
                  <input type="file" id="pdf-upload" name="pdf" accept="application/pdf" style="display:none;">
                </label>
              </div>
            </div>

            <!-- Display selected file name -->
            <span id="file-name" style="font-size:13px; color:#000; background:#fff; padding:4px 8px; border-radius:6px; margin-left:4px; border:1px solid #ccc;">OCR</span>

            <!-- Send button -->
            <button type="submit" 
                    style="padding:8px 12px; border:none; background:#4fd1c5; color:white; border-radius:6px; cursor:pointer;">
              Send
            </button>
          </div>
        </form>
      </div>


    </div>
    <!-- Room End -->

    <!--   Start -->
    <div class="room__sidebar">
      <div class="participants">
      <h3 class="participants__top">Participants <span>({{participants.count}} Joined)</span></h3>
      <div class="participants__list scroll">
        {% for user in participants %}
        <a href="{%  url 'user-profile' user.id %}" class="participant">
          <div class="avatar avatar--medium">
            <img src="{{user.avatar.url}}" />
          </div>
          <p>
            {{user.name}}
            <span>@{{user.username}}</span>
          </p>
        </a>
        {% endfor %}
      </div>
    </div>

    <!-- <div class="hashtags">
      <h3 class="participants__top">Hashtags</h3>
      <div class="participants__list scroll">
        {% for tag in hashtags %}
        <a href="?hashtag={{ tag }}" class="participant hashtag">
          {{ tag }}
        </a>

        {% empty %}
        <p>No hashtags yet</p>
        {% endfor %}
      </div>
    </div> -->
    <div class="hashtags">
  <h3 class="participants__top">Tags</h3>
  <div class="participants__list scroll">
    {% for tag in hashtags %}
      <a href="?hashtag={{ tag }}" class="participant hashtag 
         {% if tag == hashtag_filter %}selected{% endif %}">
        {{ tag }}
        {% if tag == hashtag_filter %}
          <span class="clear-hashtag">
            <a href="{% url 'room' room.id %}">&times;</a>
          </span>
        {% endif %}
      </a>
    {% empty %}
      <p>No hashtags yet</p>
    {% endfor %}
  </div>
</div>


      
    </div>
    
    <!--  End -->
  </div>
</main>
<script>
function openHashtagForm(id) {
  const form = document.getElementById(`hashtag-form-${id}`);
  if (form.style.display === 'none' || form.style.display === '') {
    form.style.display = 'flex';
  } else {
    form.style.display = 'none';
  }
}


  // const pinBtn = document.querySelector('.pin-btn');
  // const pinMenu = document.querySelector('.pin-menu');

  // pinBtn.addEventListener('click', () => {
  //   pinMenu.style.display = pinMenu.style.display === 'block' ? 'none' : 'block';
  // });

  // // Close dropdown if clicked outside
  // document.addEventListener('click', (e) => {
  //   if (!pinBtn.contains(e.target) && !pinMenu.contains(e.target)) {
  //     pinMenu.style.display = 'none';
  //   }
  // });


//   const pinBtn = document.querySelector('.pin-btn');
// const pinMenu = document.querySelector('.pin-menu');
// const imageInput = document.getElementById('image-upload');
// const pdfInput = document.getElementById('pdf-upload');
// const fileNameDisplay = document.getElementById('file-name');

// // Toggle dropup menu
// pinBtn.addEventListener('click', () => {
//   pinMenu.style.display = pinMenu.style.display === 'block' ? 'none' : 'block';
// });

// // Close dropup if clicked outside
// document.addEventListener('click', (e) => {
//   if (!pinBtn.contains(e.target) && !pinMenu.contains(e.target)) {
//     pinMenu.style.display = 'none';
//   }
// });

// // Show selected file name for image
// imageInput.addEventListener('change', () => {
//   if (imageInput.files.length > 0) {
//     fileNameDisplay.textContent = imageInput.files[0].name;
//   } else {
//     fileNameDisplay.textContent = '';
//   }
// });

// // Show selected file name for PDF
// pdfInput.addEventListener('change', () => {
//   if (pdfInput.files.length > 0) {
//     fileNameDisplay.textContent = pdfInput.files[0].name;
//   } else {
//     fileNameDisplay.textContent = '';
//   }
// });


const pinBtn = document.querySelector('.pin-btn');
const pinMenu = document.querySelector('.pin-menu');
const imageInput = document.getElementById('image-upload');
const pdfInput = document.getElementById('pdf-upload');
const fileNameDisplay = document.getElementById('file-name');

// Toggle dropup menu
pinBtn.addEventListener('click', () => {
  pinMenu.style.display = pinMenu.style.display === 'block' ? 'none' : 'block';
});

// Close dropup if clicked outside
document.addEventListener('click', (e) => {
  if (!pinBtn.contains(e.target) && !pinMenu.contains(e.target)) {
    pinMenu.style.display = 'none';
  }
});

// Function to show selected file name with remove button
function showFileName(file, inputElement) {
  fileNameDisplay.innerHTML = ''; // clear previous content

  const wrapper = document.createElement('div');
  wrapper.style.display = 'inline-flex';
  wrapper.style.alignItems = 'center';
  wrapper.style.gap = '8px';
  wrapper.style.background = '#fff';
  wrapper.style.padding = '4px 8px';
  wrapper.style.borderRadius = '6px';
  wrapper.style.border = '1px solid #ccc';

  const nameSpan = document.createElement('span');
  nameSpan.textContent = file.name;
  nameSpan.style.color = '#000';
  wrapper.appendChild(nameSpan);

  const removeBtn = document.createElement('span');
  removeBtn.textContent = '✖';
  removeBtn.style.cursor = 'pointer';
  removeBtn.style.color = '#f00';
  removeBtn.style.fontWeight = 'bold';
  removeBtn.addEventListener('click', () => {
    inputElement.value = ''; // clear file input
    fileNameDisplay.innerHTML = 'OCR'; // remove display
  });
  wrapper.appendChild(removeBtn);

  fileNameDisplay.appendChild(wrapper);
}

// Show selected file name for image
imageInput.addEventListener('change', () => {
  if (imageInput.files.length > 0) {
    showFileName(imageInput.files[0], imageInput);
  } else {
    fileNameDisplay.innerHTML = '';
  }
});

// Show selected file name for PDF
pdfInput.addEventListener('change', () => {
  if (pdfInput.files.length > 0) {
    showFileName(pdfInput.files[0], pdfInput);
  } else {
    fileNameDisplay.innerHTML = '';
  }
});

</script>

<!-- <script src="script.js"></script> -->
{% endblock content %}